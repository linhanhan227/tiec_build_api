# TieCloud Build API - å®Œæ•´é¡¹ç›®æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

**TieCloud Build API** æ˜¯ä¸º TieCloud å¹³å°è®¾è®¡çš„åç«¯æ„å»ºæœåŠ¡ï¼Œä½¿ç”¨ Rust å¼€å‘ï¼Œæä¾›é¢å‘ .tsp é¡¹ç›®çš„ç¼–è¯‘ã€æ„å»ºå’Œä¸‹è½½èƒ½åŠ›ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ“¤ ä¸Šä¼  .tspï¼ˆZIP æ ¼å¼ï¼‰é¡¹ç›®æ–‡ä»¶ï¼Œç”Ÿæˆå”¯ä¸€ file_id
- ğŸ”¨ åˆ›å»ºæ„å»ºä»»åŠ¡ï¼Œæ”¯æŒé˜Ÿåˆ—ç®¡ç†å’Œä¼˜å…ˆçº§è°ƒåº¦
- ğŸ“Š å®æ—¶æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å’Œæ„å»ºäº‹ä»¶æ—¥å¿—
- ğŸ“¥ æˆåŠŸæ„å»ºåä¸‹è½½ APK æ–‡ä»¶
- ğŸ’“ å¥åº·æ£€æŸ¥ä¸ç³»ç»Ÿç»Ÿè®¡
- ğŸš€ å†…ç½® OpenAPI/Swagger æ–‡æ¡£
- âš¡ åˆ†å±‚é€Ÿç‡é™åˆ¶ï¼ˆç§’çº§ + å°æ—¶çº§ï¼‰

---

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | è¯´æ˜ |
| --- | --- |
| **Web æ¡†æ¶** | actix-web 4.9 |
| **å¼‚æ­¥è¿è¡Œæ—¶** | tokio 1.43 |
| **æ•°æ®åº“** | SQLite 3ï¼ˆrusqliteï¼‰ |
| **é˜Ÿåˆ—ç®¡ç†** | VecDeque + DashMapï¼ˆå†…å­˜ç¼“å­˜ï¼‰ |
| **API æ–‡æ¡£** | utoipa + utoipa-swagger-ui |
| **é™æµæ§åˆ¶** | actix-governorï¼ˆç§’çº§ï¼‰+ è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼ˆå°æ—¶çº§ï¼‰ |
| **æ–‡ä»¶å¤„ç†** | zip 2.2 + actix-multipart 0.7 |
| **åºåˆ—åŒ–** | serde + serde_json |
| **æ„å»ºå·¥å…·é“¾** | Rust 2021 Edition |

---

## é¡¹ç›®ç»“æ„

```
TieApi/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                 # åº”ç”¨å…¥å£ã€æœåŠ¡å™¨åˆå§‹åŒ–
â”‚   â”œâ”€â”€ config.rs               # ç¯å¢ƒå˜é‡é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ state.rs                # åº”ç”¨å…¨å±€çŠ¶æ€ï¼ˆDashMap + ç»Ÿè®¡ï¼‰
â”‚   â”œâ”€â”€ database.rs             # SQLite æ“ä½œä¸è¿ç§»é€»è¾‘ï¼ˆ919 è¡Œï¼‰
â”‚   â”œâ”€â”€ error.rs                # é”™è¯¯å¤„ç†ä¸å“åº”æ˜ å°„
â”‚   â”œâ”€â”€ middleware.rs           # IP é™æµä¸å°ç¦ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ utils.rs                # å·¥å…·å‡½æ•°ï¼ˆZIP å®‰å…¨æå–ã€IP è¯†åˆ«ï¼‰
â”‚   â”œâ”€â”€ assets.rs               # åµŒå…¥å¼èµ„æºç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ mod.rs              # API æ¨¡å—å£°æ˜
â”‚   â”‚   â”œâ”€â”€ upload.rs           # POST /api/v1/uploadï¼ˆ172 è¡Œï¼‰
â”‚   â”‚   â”œâ”€â”€ build.rs            # POST /api/v1/buildã€GET çŠ¶æ€/äº‹ä»¶
â”‚   â”‚   â”œâ”€â”€ download.rs         # GET /api/v1/build/{id}/download
â”‚   â”‚   â”œâ”€â”€ health.rs           # GET /health
â”‚   â”‚   â””â”€â”€ cleanup.rs          # ç®¡ç†å‘˜æ¸…ç†æ¥å£ï¼ˆå†…éƒ¨ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ mod.rs              # æ¨¡å‹å¯¼å‡º
â”‚   â”‚   â””â”€â”€ task.rs             # TaskStatusã€Taskã€TaskEvent å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ worker/
â”‚   â”‚   â””â”€â”€ mod.rs              # åå°ä»»åŠ¡å¤„ç†ä¸æ¸…ç†é€»è¾‘ï¼ˆ462 è¡Œï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ stdlib/                 # æ ‡å‡†åº“ä¸ç¼–è¯‘å™¨å·¥å…·é“¾
â”‚   â”‚   â”œâ”€â”€ android/            # Android ä¾èµ–åº“ä¸æºç 
â”‚   â”‚   â”œâ”€â”€ web/                # Web ç»„ä»¶ä¸èµ„æº
â”‚   â”‚   â””â”€â”€ windows/            # Windows ç¼–è¯‘å·¥å…·é“¾
â”‚   â”‚
â”‚   â””â”€â”€ tiecc/                  # ç¼–è¯‘å™¨äºŒè¿›åˆ¶
â”‚       â”œâ”€â”€ linux_x86_64/
â”‚       â”œâ”€â”€ linux_arm64-v8a/
â”‚       â”œâ”€â”€ macos/
â”‚       â””â”€â”€ win_x86_64/
â”‚
â”œâ”€â”€ Cargo.toml                  # é¡¹ç›®é…ç½®ä¸ä¾èµ–
â”œâ”€â”€ build.rs                    # ç¼–è¯‘è„šæœ¬ï¼ˆåµŒå…¥èµ„æºã€ç‰ˆæœ¬ä¿¡æ¯ï¼‰
â”œâ”€â”€ APIæ–‡æ¡£.md                  # å®Œæ•´æ¥å£æ–‡æ¡£
â”œâ”€â”€ README.md                   # å¿«é€Ÿå¼€å§‹æŒ‡å—
â”œâ”€â”€ ç¼–è¯‘å‘½ä»¤è¯´æ˜.txt             # tiecc ç¼–è¯‘å·¥å…·ç”¨æ³•
â”‚
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ rust-ci-cross-compile.yml  # CI/CD è·¨å¹³å°æ„å»º
â”‚
â””â”€â”€ target/                     # æ„å»ºè¾“å‡ºç›®å½•
    â””â”€â”€ release/
        â”œâ”€â”€ tie_api_server      # æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶
        â””â”€â”€ build/              # ä¸­é—´æ„å»ºæ–‡ä»¶
```

---

## æ ¸å¿ƒæ¶æ„

### 1. åº”ç”¨åˆå§‹åŒ–æµç¨‹ (`main.rs`)

```
åˆå§‹åŒ–è¿‡ç¨‹ï¼š
  â”œâ”€ åŠ è½½ç¯å¢ƒå˜é‡é…ç½® (Config::from_env)
  â”œâ”€ åˆå§‹åŒ– SQLite æ•°æ®åº“
  â”œâ”€ åˆ›å»ºå…±äº«ä»»åŠ¡é˜Ÿåˆ— (Arc<Mutex<VecDeque>>)
  â”œâ”€ åˆå§‹åŒ–åº”ç”¨å…¨å±€çŠ¶æ€ (AppState)
  â”œâ”€ æå–åµŒå…¥å¼èµ„æºåˆ° .tiec/ï¼ˆç¼–è¯‘å·¥å…·é“¾ã€æ ‡å‡†åº“ï¼‰
  â”œâ”€ ä»æ•°æ®åº“æ¢å¤å†å²ä»»åŠ¡
  â”œâ”€ å¯åŠ¨ N ä¸ªåå° Worker (tokio::spawn)
  â”œâ”€ å¯åŠ¨å®šæœŸæ¸…ç†ä»»åŠ¡ (cleanup_task)
  â”œâ”€ é…ç½®é™æµä¸­é—´ä»¶
  â””â”€ å¯åŠ¨ Actix-web æœåŠ¡å™¨
```

### 2. å…¨å±€çŠ¶æ€ç®¡ç† (`state.rs`)

```rust
pub struct AppState {
    pub tasks: DashMap<Uuid, Task>,              // å†…å­˜ä»»åŠ¡ç¼“å­˜
    pub upload_dir: String,                      // ä¸Šä¼ ç›®å½•
    pub tiecc_dir: String,                       // ç¼–è¯‘å™¨è·¯å¾„
    pub stdlib_dir: String,                      // æ ‡å‡†åº“è·¯å¾„
    pub queue_capacity: usize,                   // é˜Ÿåˆ—ä¸Šé™
    pub database: Database,                      // SQLite è¿æ¥æ± 
    pub total_tasks: AtomicU64,                  // æ€»ä»»åŠ¡æ•°ï¼ˆç»Ÿè®¡ï¼‰
    pub completed_tasks: AtomicU64,              // å·²å®Œæˆæ•°
    pub failed_tasks: AtomicU64,                 // å¤±è´¥æ•°
    pub active_workers: AtomicU64,               // æ´»è·ƒ Worker æ•°
}
```

### 3. æ•°æ®åº“è®¾è®¡ (`database.rs`)

#### è¡¨ç»“æ„

**tasks è¡¨**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| task_id | TEXT PRIMARY KEY | UUID æ ¼å¼ |
| status | TEXT | ä»»åŠ¡çŠ¶æ€ï¼ˆæ’é˜Ÿä¸­/å¤„ç†ä¸­/æˆåŠŸ/å¤±è´¥/å·²å–æ¶ˆï¼‰ |
| progress | INTEGER | è¿›åº¦ 0-100 |
| current_step | TEXT | å½“å‰æ­¥éª¤è¯´æ˜ |
| error | TEXT | é”™è¯¯ä¿¡æ¯ |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ï¼ˆRFC3339ï¼‰ |
| updated_at | TEXT | æ›´æ–°æ—¶é—´ |
| retry_count | INTEGER | é‡è¯•æ¬¡æ•° |
| max_retries | INTEGER | æœ€å¤§é‡è¯•æ•°ï¼ˆé»˜è®¤ 3ï¼‰ |
| build_duration | INTEGER | æ„å»ºè€—æ—¶ï¼ˆç§’ï¼‰ |
| priority | INTEGER | ä¼˜å…ˆçº§ï¼ˆé»˜è®¤ 0ï¼‰ |
| file_id | TEXT | ä¸Šä¼ æ–‡ä»¶ SHA1 |
| file_path | TEXT | é¡¹ç›®æ–‡ä»¶è·¯å¾„ |
| output_path | TEXT | APK è¾“å‡ºè·¯å¾„ |
| user_id | TEXT | ç”¨æˆ· IP åœ°å€ |
| locked_by | TEXT | å½“å‰å¤„ç† Worker ID |
| lease_until | TEXT | ä»»åŠ¡é”è¶…æœŸæ—¶é—´ |
| next_run_at | TEXT | é‡è¯•è®¡åˆ’æ—¶é—´ |
| last_error | TEXT | æœ€è¿‘ä¸€æ¬¡é”™è¯¯ä¿¡æ¯ |

**task_events è¡¨**
| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| id | INTEGER PRIMARY KEY | è‡ªå¢ ID |
| task_id | TEXT | ä»»åŠ¡ UUID |
| event_type | TEXT | äº‹ä»¶ç±»å‹ï¼ˆlog/status_changeï¼‰ |
| status | TEXT | ä»»åŠ¡çŠ¶æ€å¿«ç…§ |
| message | TEXT | äº‹ä»¶ä¿¡æ¯ |
| worker_id | TEXT | äº‹ä»¶æ¥æº Worker |
| created_at | TEXT | æ—¶é—´æˆ³ |

**schema_migrations è¡¨**
- ç‰ˆæœ¬æ§åˆ¶è¡¨ï¼Œæ”¯æŒ 6 ä¸ªè¿ç§»ç‰ˆæœ¬

### 4. API å¤„ç†æµç¨‹

#### ä¸Šä¼ æµç¨‹ (`api/upload.rs`)

```
POST /api/v1/upload
  â”‚
  â”œâ”€ éªŒè¯ Content-Disposition
  â”œâ”€ æ ¡éªŒæ–‡ä»¶æ‰©å±•åï¼ˆ.tspï¼‰
  â”œâ”€ æ ¡éªŒ MIME ç±»å‹ï¼ˆapplication/zipï¼‰
  â”œâ”€ æµå¼è¯»å–æ–‡ä»¶å¹¶è®¡ç®— SHA1
  â”œâ”€ éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆâ‰¤ 100MBï¼‰
  â”œâ”€ éªŒè¯ ZIP å®Œæ•´æ€§
  â”œâ”€ è‡ªåŠ¨è§£å‹åˆ° {upload_dir}/{file_id}_extracted/
  â”œâ”€ å¯åŠ¨æ—¶åˆå§‹åŒ–åŸºç¡€èµ„æºä¸æ ‡å‡†åº“
  â””â”€ è¿”å› UploadResponse { file_id }
```

#### æ„å»ºæµç¨‹ (`api/build.rs`)

```
POST /api/v1/build
  â”‚
  â”œâ”€ éªŒè¯ file_id æ ¼å¼ï¼ˆ40 ä½åå…­è¿›åˆ¶ï¼‰
  â”œâ”€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœªç»“æŸçš„åŒæ–‡ä»¶ä»»åŠ¡ï¼ˆå¤ç”¨ï¼‰
  â”œâ”€ åˆ›å»ºæ–° Taskï¼ˆQueued çŠ¶æ€ï¼‰
  â”œâ”€ æ’å…¥ DashMap å†…å­˜ç¼“å­˜
  â”œâ”€ ä¿å­˜åˆ° SQLite æ•°æ®åº“
  â”œâ”€ åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—
  â”œâ”€ æ›´æ–°ç»Ÿè®¡è®¡æ•°å™¨
  â””â”€ è¿”å› BuildResponse { task_id, status }
```

#### æ‰§è¡Œæµç¨‹ (`worker/mod.rs`)

```
Worker ä¸»å¾ªç¯ï¼š
  â”œâ”€ ä»æ•°æ®åº“ç§Ÿèµä¸‹ä¸€ä¸ªä»»åŠ¡ (lease_next_task)
  â”œâ”€ åå°å¯åŠ¨ç»­ç§Ÿä»»åŠ¡ï¼ˆé˜²æ­¢è¶…æ—¶ï¼‰
  â”‚
  â”œâ”€ [å¤„ç†ä¸­] çŠ¶æ€æ›´æ–°
  â”œâ”€ è§£å‹é¡¹ç›®æ–‡ä»¶ï¼ˆå« Zip Slip æ£€æŸ¥ï¼‰
  â”œâ”€ æå–èµ„æºï¼ˆç¼–è¯‘å·¥å…·ã€æ ‡å‡†åº“ï¼‰
  â”œâ”€ æ ¡éªŒ/å‡†å¤‡ project.jsonï¼ˆå¦‚ä»…å­˜åœ¨ build/project.json åˆ™å¤åˆ¶åˆ°æ ¹ç›®å½•ï¼‰
  â”‚
  â”œâ”€ æ‰§è¡Œç¼–è¯‘ï¼šæ ¹æ® OS/ARCH é€‰æ‹© .tiec/tiecc ä¸‹å¯¹åº”äºŒè¿›åˆ¶
  â”‚   â””â”€ å®æ—¶è¯»å– stdout/stderrï¼ˆæ—¥å¿—å†™å…¥ï¼‰
  â”‚
  â”œâ”€ ç¼–è¯‘æˆåŠŸ
  â”‚   â”œâ”€ è§£æè¾“å‡º APK è·¯å¾„
  â”‚   â”œâ”€ çŠ¶æ€æ”¹ä¸º Success
  â”‚   â””â”€ ä¿å­˜è¾“å‡ºè·¯å¾„
  â”‚
  â”œâ”€ ç¼–è¯‘å¤±è´¥/è¶…æ—¶
  â”‚   â”œâ”€ åˆ¤æ–­æ˜¯å¦å¯é‡è¯•ï¼ˆretry_count < max_retriesï¼‰
  â”‚   â”œâ”€ å¯é‡è¯•ï¼šçŠ¶æ€æ”¹ä¸º Queuedï¼Œæ’å®š next_run_at
  â”‚   â””â”€ ä¸å¯é‡è¯•ï¼šçŠ¶æ€æ”¹ä¸º Failed
  â”‚
  â””â”€ æ¸…ç†ç§Ÿçº¦ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡
```

### 5. é™æµæœºåˆ¶

#### ç§’çº§é™æµ (IP RateLimiter)
- **é™åˆ¶**ï¼šæ¯ IP æ¯ç§’ 120 è¯·æ±‚
- **è¶…é™è¡Œä¸º**ï¼šç«‹å³å°ç¦ 7 å¤©ï¼Œè®°å½•åˆ° `.tiec/ip_ban.txt`
- **å®ç°**ï¼šactix-governor ä¸­é—´ä»¶

#### å°æ—¶çº§é™æµ (Hourly IP Limiter)
- **é™åˆ¶**ï¼šé»˜è®¤æ¯ IP æ¯å°æ—¶ 20 æ¬¡ï¼ˆå¯é…ç½® `HOURLY_IP_LIMIT`ï¼‰
- **ç”Ÿæ•ˆæ¥å£**ï¼š
  - `POST /api/v1/upload`
  - `POST /api/v1/build`
  - `GET /api/v1/build/{id}/status`
  - `GET /api/v1/build/{id}/events`
  - `GET /api/v1/build/{id}/download`
- **å®ç°**ï¼šè‡ªå®šä¹‰ä¸­é—´ä»¶ï¼Œå†…å­˜è®¡æ•°å™¨ + æ—¶é—´æˆ³

---

## æ•°æ®æµè½¬

### å®Œæ•´è¯·æ±‚æµç¨‹ç¤ºä¾‹

```
å®¢æˆ·ç«¯                      æœåŠ¡å™¨
   â”‚
   â”œâ”€ [1] ä¸Šä¼  .tsp æ–‡ä»¶
   â”‚   â””â”€â”€â”€> POST /api/v1/upload
   â”‚          (multipart/form-data)
   â”‚   <â”€â”€â”€  { file_id: "abc123..." }
   â”‚
   â”œâ”€ [2] åˆ›å»ºæ„å»ºä»»åŠ¡
   â”‚   â””â”€â”€â”€> POST /api/v1/build
   â”‚          { file_id: "abc123..." }
   â”‚   <â”€â”€â”€  { task_id: "uuid-xxx", status: "æ’é˜Ÿä¸­" }
   â”‚          (HTTP 202)
   â”‚
   â”œâ”€ [3] è½®è¯¢ä»»åŠ¡çŠ¶æ€ (0.5s ä¸€æ¬¡)
   â”‚   â””â”€â”€â”€> GET /api/v1/build/uuid-xxx/status
   â”‚   <â”€â”€â”€  { task_id: "...", status: "å¤„ç†ä¸­", 
   â”‚           progress: 45, current_step: "ç¼–è¯‘ä¸­" }
   â”‚
   â”œâ”€ [4] æŸ¥è¯¢ä»»åŠ¡äº‹ä»¶æ—¥å¿—
   â”‚   â””â”€â”€â”€> GET /api/v1/build/uuid-xxx/events?limit=20
   â”‚   <â”€â”€â”€  [ { id: 1, event_type: "log", 
   â”‚             message: "ç¼–è¯‘å¼€å§‹", ... }, ... ]
   â”‚
   â”œâ”€ [5] æ„å»ºå®Œæˆï¼Œä¸‹è½½ APK
   â”‚   â””â”€â”€â”€> GET /api/v1/build/uuid-xxx/download
   â”‚   <â”€â”€â”€  app-uuid-xxx.apk (binary stream)
   â”‚
   â””â”€ [6] å¥åº·æ£€æŸ¥
       â””â”€â”€â”€> GET /health
       <â”€â”€â”€  { status: "healthy", queue_size: 2, 
               total_tasks: 100, ... }
```

---

## ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡ | é»˜è®¤å€¼ | èŒƒå›´ | è¯´æ˜ |
| --- | --- | --- | --- |
| `HOST` | 0.0.0.0 | IP åœ°å€ | ç›‘å¬åœ°å€ |
| `PORT` | 8080 | 1024-65535 | ç›‘å¬ç«¯å£ |
| `UPLOAD_DIR` | `./.tiec/uploads` | è·¯å¾„ | ä¸Šä¼ ä¸è§£å‹ç›®å½• |
| `DATABASE_PATH` | `./.tiec/tasks.db` | è·¯å¾„ | SQLite æ•°æ®åº“æ–‡ä»¶ |
| `QUEUE_CAPACITY` | 15 | æ­£æ•´æ•° | æœ€å¤šæ’é˜Ÿä»»åŠ¡æ•° |
| `WORKER_COUNT` | 1 | 1-16 | åå° Worker çº¿ç¨‹æ•° |
| `TASK_TIMEOUT` | 900 | ç§’ | å•ä¸ªä»»åŠ¡è¶…æ—¶æ—¶é—´ |
| `CLEANUP_INTERVAL` | 3600 | ç§’ | å®šæœŸæ¸…ç†é—´éš” |
| `HOURLY_IP_LIMIT` | 20 | æ­£æ•´æ•° | æ¯ IP æ¯å°æ—¶è¯·æ±‚é™åˆ¶ |

### é…ç½®ç¤ºä¾‹

```bash
# å¼€å‘ç¯å¢ƒ
export HOST=127.0.0.1
export PORT=3000
export WORKER_COUNT=2
export UPLOAD_DIR=/tmp/tiecloud/uploads
export HOURLY_IP_LIMIT=50

# ç”Ÿäº§ç¯å¢ƒ
export HOST=0.0.0.0
export PORT=8080
export WORKER_COUNT=4
export TASK_TIMEOUT=1800
export HOURLY_IP_LIMIT=20
```

---

## ç¼–è¯‘ä¸éƒ¨ç½²

### ç¼–è¯‘æŒ‡ä»¤

```bash
# æœ¬åœ°å¼€å‘æ„å»º
cargo build --release

# ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
./target/release/tie_api_server

# æŒ‡å®šç¼–è¯‘ç›®æ ‡ï¼ˆäº¤å‰ç¼–è¯‘ï¼‰
cargo build --release --target x86_64-unknown-linux-gnu
cargo build --release --target aarch64-unknown-linux-gnu
cargo build --release --target x86_64-pc-windows-msvc
```

### ä½¿ç”¨ Cross è¿›è¡Œäº¤å‰ç¼–è¯‘

```bash
cargo install cross --git https://github.com/cross-rs/cross

# Linux GNU
cross build --release --target x86_64-unknown-linux-gnu

# Linux muslï¼ˆalpine å…¼å®¹ï¼‰
cross build --release --target x86_64-unknown-linux-musl

# ARM64
cross build --release --target aarch64-unknown-linux-gnu
```

### CI/CD å·¥ä½œæµ (GitHub Actions)

å·¥ä½œæµæ–‡ä»¶ï¼š`.github/workflows/rust-ci-cross-compile.yml`

#### æƒé™ä¸å‘å¸ƒè¯´æ˜
- å·¥ä½œæµæ˜¾å¼æˆäºˆ `contents: write`ï¼Œç”¨äºå‘å¸ƒ Release èµ„äº§
- Release ä¸Šä¼ ä½¿ç”¨ `GITHUB_TOKEN`
- ä»…åœ¨ `release` äº‹ä»¶è§¦å‘æ—¶ä¸Šä¼ åˆ° Release

#### å·¥ä½œæµè§¦å‘æ¡ä»¶
- æ¨é€åˆ° `main` åˆ†æ”¯
- åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾ `v*`
- å‘å¸ƒ Release

#### ç¼–è¯‘çŸ©é˜µ
1. **Linux**
   - `x86_64-unknown-linux-gnu` â†’ `linux-amd64`
   - `x86_64-unknown-linux-musl` â†’ `linux-amd64-musl`
   - `aarch64-unknown-linux-gnu` â†’ `linux-arm64`
   - `aarch64-unknown-linux-musl` â†’ `linux-arm64-musl`

2. **Windows**
   - `x86_64-pc-windows-msvc` â†’ `windows-amd64`
   - `aarch64-pc-windows-msvc` â†’ `windows-arm64`

3. **macOS**
   - `x86_64-apple-darwin` â†’ `darwin-amd64`
   - `aarch64-apple-darwin` â†’ `darwin-arm64`

#### æ„å»ºäº§ç‰©ä¸å‘½åè§„åˆ™
- äºŒè¿›åˆ¶åç”±ç¯å¢ƒå˜é‡ `BINARY_NAME` æ§åˆ¶ï¼ˆé»˜è®¤ `tie_api_server`ï¼‰
- Linux ä¸ macOS æ‰“åŒ…ä¸º `tar.gz`ï¼ŒWindows æ‰“åŒ…ä¸º `zip`
- æ ¡éªŒå’Œæ–‡ä»¶åç¼€ä¸º `.sha256`
- èµ„äº§å‘½åç¤ºä¾‹ï¼š
  - Linux: `tie_api_server-linux-amd64.tar.gz`
  - Linux musl: `tie_api_server-linux-amd64-musl.tar.gz`
  - Windows: `tie_api_server-windows-amd64.zip`
  - macOS: `tie_api_server-darwin-arm64.tar.gz`

#### å·¥ä½œæµæ­¥éª¤
1. æ£€å‡ºä»£ç 
2. å®‰è£… Rust å·¥å…·é“¾ä¸ç›®æ ‡
3. ç¼“å­˜ Cargo ä¾èµ–
4. ç¼–è¯‘äºŒè¿›åˆ¶
5. Strip ç¬¦å·è¡¨ï¼ˆå‡å°å¤§å°ï¼‰
6. æ‰“åŒ…ï¼ˆtar.gz æˆ– zipï¼‰
7. ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
8. ä¸Šä¼ åˆ° GitHub Artifacts
9. å‘å¸ƒåˆ° Releaseï¼ˆå¦‚ä¸ºå‘å¸ƒäº‹ä»¶ï¼‰
10. è‡ªåŠ¨ç”Ÿæˆ Nightly ç‰ˆæœ¬ï¼ˆmain åˆ†æ”¯æ¨é€ï¼‰

#### ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨ `actions/cache@v3` ç¼“å­˜ Cargo registryã€git db ä¸ target ç›®å½•
- ç¼“å­˜ key åŸºäº `Cargo.lock` å“ˆå¸Œä¸ç›®æ ‡ triple

#### Nightly å‘å¸ƒ
- ä»…åœ¨ `main` åˆ†æ”¯æ¨é€æ—¶æ‰§è¡Œ
- Tag è§„åˆ™ï¼š`nightly-YYYYMMDDHHMM`ï¼ˆUTCï¼‰
- `prerelease: true`ï¼Œå°†æ‰€æœ‰å¹³å°æ„å»ºäº§ç‰©åˆå¹¶ä¸Šä¼ 

#### å¤±è´¥æ’æŸ¥å»ºè®®
- Linux äº¤å‰ç¼–è¯‘ä¾èµ– `cross`ï¼Œå¦‚å¤±è´¥è¯·æ£€æŸ¥ Docker å¯ç”¨æ€§
- Windows ARM64 å¯ç”¨ `llvm-strip` æˆ–è·³è¿‡ strip
- macOS ä½¿ç”¨ç³»ç»Ÿ `strip`ï¼Œå¯åœ¨å¤±è´¥æ—¶ç›´æ¥è·³è¿‡

### éƒ¨ç½²è¯´æ˜ï¼ˆæ‰‹åŠ¨ï¼‰

#### è¿è¡Œå‰å‡†å¤‡
- ç¡®ä¿å·¥ä½œç›®å½•å¯å†™ï¼ˆæœåŠ¡ä¼šåˆ›å»º `./.tiec`ï¼‰
- ç¡®ä¿ç«¯å£å¯ç”¨ï¼ˆé»˜è®¤ `8080`ï¼‰
- å¦‚ä½¿ç”¨åå‘ä»£ç†ï¼Œç¡®ä¿ä»£ç†è½¬å‘çœŸå® IPï¼ˆ`X-Forwarded-For`ï¼‰

#### æ¨èå¯åŠ¨æ–¹å¼

```bash
export HOST=0.0.0.0
export PORT=8080
export UPLOAD_DIR=./.tiec/uploads
export DATABASE_PATH=./.tiec/tasks.db
export WORKER_COUNT=2
export TASK_TIMEOUT=900
export CLEANUP_INTERVAL=3600
export HOURLY_IP_LIMIT=20

./tie_api_server
```

#### systemd ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰

```ini
[Unit]
Description=TieCloud Build API
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/tie_api
ExecStart=/opt/tie_api/tie_api_server
Restart=always
Environment=HOST=0.0.0.0
Environment=PORT=8080
Environment=UPLOAD_DIR=/opt/tie_api/.tiec/uploads
Environment=DATABASE_PATH=/opt/tie_api/.tiec/tasks.db
Environment=WORKER_COUNT=2
Environment=TASK_TIMEOUT=900
Environment=CLEANUP_INTERVAL=3600
Environment=HOURLY_IP_LIMIT=20

[Install]
WantedBy=multi-user.target
```

#### åå‘ä»£ç†æç¤º
- å»ºè®®åœ¨ Nginx/Traefik åå¯ç”¨ HTTPS
- ä¸Šä¼ æ¥å£å»ºè®®è®¾ç½®è¾ƒå¤§ `client_max_body_size`ï¼ˆâ‰¥ 100MBï¼‰

---

## API å®Œæ•´è§„èŒƒ

### 1. å¥åº·æ£€æŸ¥

**GET /health**

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "healthy",
  "queue_size": 0,
  "active_tasks": 1,
  "total_tasks": 10,
  "completed_tasks": 8,
  "failed_tasks": 1,
  "uptime": 3600,
  "version": "1.0.0",
  "build_time": "2026-02-01T00:00:00Z",
  "git_commit": "abcdef",
  "git_branch": "main"
}
```

### 2. ä¸Šä¼ æ–‡ä»¶

**POST /api/v1/upload**

è¯·æ±‚ï¼šmultipart/form-dataï¼ŒåŒ…å« `file` å­—æ®µï¼ˆ.tsp æ–‡ä»¶ï¼‰

å“åº” 200ï¼š
```json
{
  "code": 200,
  "data": {
    "file_id": "a1b2c3d4e5f6... (40 ä½ SHA1)"
  }
}
```

é”™è¯¯å“åº” 400ï¼š
```json
{
  "code": 400,
  "message": "Invalid file extension. Only .tsp files are allowed."
}
```

### 3. åˆ›å»ºæ„å»ºä»»åŠ¡

**POST /api/v1/build**

è¯·æ±‚ä½“ï¼š
```json
{
  "file_id": "a1b2c3d4e5f6... (40 ä½åå…­è¿›åˆ¶)"
}
```

å“åº” 202ï¼š
```json
{
  "code": 202,
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "æ’é˜Ÿä¸­"
  }
}
```

### 4. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

**GET /api/v1/build/{id}/status**

å“åº” 200ï¼š
```json
{
  "code": 200,
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "å¤„ç†ä¸­",
    "progress": 45,
    "estimated_time_remaining": 120,
    "current_step": "ç¼–è¯‘ä¸­",
    "error": null,
    "created_at": "2026-02-01T10:00:00Z",
    "updated_at": "2026-02-01T10:00:30Z",
    "retry_count": 0,
    "max_retries": 3,
    "build_duration": null,
    "priority": 0
  }
}
```

### 5. æŸ¥è¯¢ä»»åŠ¡äº‹ä»¶

**GET /api/v1/build/{id}/events?limit=50&offset=0**

å“åº” 200ï¼š
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "task_id": "550e8400-e29b-41d4-a716-446655440000",
      "event_type": "log",
      "status": "å¤„ç†ä¸­",
      "message": "ç¼–è¯‘å¼€å§‹",
      "worker_id": "worker-0",
      "created_at": "2026-02-01T10:00:10Z"
    },
    {
      "id": 2,
      "task_id": "550e8400-e29b-41d4-a716-446655440000",
      "event_type": "log",
      "status": "å¤„ç†ä¸­",
      "message": "[ç¼–è¯‘å™¨] æ­£åœ¨ç¼–è¯‘æºæ–‡ä»¶...",
      "worker_id": "worker-0",
      "created_at": "2026-02-01T10:00:15Z"
    }
  ]
}
```

### 6. ä¸‹è½½ APK

**GET /api/v1/build/{id}/download**

å“åº” 200ï¼šäºŒè¿›åˆ¶æµï¼ŒContent-Type: `application/vnd.android.package-archive`
- æ–‡ä»¶åï¼š`app-{task_id}.apk`

---

## å…³é”®è®¾è®¡å†³ç­–

### 1. å¤šå±‚çŠ¶æ€å­˜å‚¨
- **å†…å­˜ (DashMap)**ï¼šé«˜é¢‘è¯»å–ï¼ˆæŸ¥è¯¢çŠ¶æ€ï¼‰
- **æ•°æ®åº“ (SQLite)**ï¼šæŒä¹…åŒ–ï¼Œæ”¯æŒæ¢å¤å’Œç»Ÿè®¡

### 2. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **ç§Ÿçº¦é” (Lease)**ï¼šWorker è·å¾—ä»»åŠ¡åè®¾ç½®é”ï¼Œå®šæœŸç»­ç§Ÿ
- **è¶…æ—¶å¤„ç†**ï¼šç§Ÿçº¦è¿‡æœŸåä»»åŠ¡å¯è¢«å…¶ä»– Worker è®¤é¢†
- **é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥ä»»åŠ¡åˆ¤æ–­æ˜¯å¦å¯é‡è¯•ï¼Œæ’å®š next_run_at

### 3. æµå¼æ—¥å¿—å¤„ç†
- Worker å®æ—¶è¯»å–ç¼–è¯‘å·¥å…·çš„ stdout
- æ¯è¡Œæ—¥å¿—åˆ›å»ºä¸€æ¡ TaskEvent è®°å½•
- å®¢æˆ·ç«¯è½®è¯¢è·å–äº‹ä»¶

### 4. ZIP å®‰å…¨æå–
- æ£€æŸ¥ Zip Slip æ¼æ´ï¼ˆç›®å½•éå†ï¼‰
- ä½¿ç”¨è·¯å¾„æ£€æŸ¥ï¼š`if !outpath.starts_with(dest)`

### 5. ä¸¤å±‚é™æµè®¾è®¡
- **ç§’çº§**ï¼šçªå‘è¯·æ±‚é˜²æŠ¤ï¼ˆ120 req/sï¼‰
- **å°æ—¶çº§**ï¼šèµ„æºæ¶ˆè€—é™åˆ¶ï¼ˆ20 req/h é’ˆå¯¹æ„å»ºæ¥å£ï¼‰
- **ç‹¬ç«‹ IP è¿½è¸ª**ï¼šæ”¯æŒ IPv4 åœ°å€è¯†åˆ«ï¼ˆX-Forwarded-For æ”¯æŒï¼‰

---

## æ€§èƒ½ç‰¹ç‚¹

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
| --- | --- | --- |
| **å¹¶å‘æ”¯æŒ** | âˆï¼ˆtokio å¼‚æ­¥ï¼‰ | Actix-web å¤šçº¿ç¨‹ + tokio å¼‚æ­¥ runtime |
| **é˜Ÿåˆ—æ·±åº¦** | å¯é…ç½® 15-100 | é˜²æ­¢å†…å­˜æº¢å‡º |
| **å•ä»»åŠ¡è¶…æ—¶** | 900 ç§’ï¼ˆå¯é…ï¼‰ | 15 åˆ†é’Ÿé»˜è®¤æ„å»ºæ—¶é™ |
| **å†…å­˜å ç”¨** | ~50-100MB | åŸºç¡€è¿›ç¨‹ï¼Œéšç¼“å­˜ä»»åŠ¡å¢åŠ  |
| **æ•°æ®åº“æ€§èƒ½** | SQLiteï¼ˆæœ¬åœ°å•æ–‡ä»¶ï¼‰ | ä¸æ”¯æŒè¿œç¨‹ï¼Œä½†è¶³ä»¥æ»¡è¶³å•æœºéœ€æ±‚ |
| **æ–‡ä»¶ä¸Šä¼ é™åˆ¶** | 100MB | é˜²æ­¢å¤§å‹ ZIP å¯¼è‡´å†…å­˜æº¢å‡º |

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šä»»åŠ¡å§‹ç»ˆ Queued
**åŸå› **ï¼šWorker è¿›ç¨‹æœªå¯åŠ¨æˆ–ç§Ÿçº¦ç®¡ç†å¤±è´¥
**æ£€æŸ¥**ï¼š
```bash
ps aux | grep tie_api_server          # ç¡®è®¤è¿›ç¨‹è¿è¡Œ
sqlite3 .tiec/tasks.db "SELECT COUNT(*) FROM tasks WHERE status = 'æ’é˜Ÿä¸­';" 
```
**è§£å†³**ï¼šé‡å¯æœåŠ¡

### é—®é¢˜ 2ï¼šæ„å»ºè¶…æ—¶
**åŸå› **ï¼šç¼–è¯‘å·¥å…·é“¾ç¼ºå¤±æˆ–é¡¹ç›®å¤æ‚åº¦é«˜
**æ£€æŸ¥**ï¼š
```bash
ls -la .tiec/tiecc/*/tiec              # éªŒè¯ç¼–è¯‘å™¨å­˜åœ¨
```
**è§£å†³**ï¼šå¢åŠ  `TASK_TIMEOUT` æˆ– `WORKER_COUNT`

### é—®é¢˜ 3ï¼šIP è¢«å°ç¦
**åŸå› **ï¼šç§’çº§é™æµè§¦å‘ï¼ˆ120 req/sï¼‰
**æ£€æŸ¥**ï¼š
```bash
cat .tiec/ip_ban.txt                    # æŸ¥çœ‹å°ç¦åˆ—è¡¨
```
**è§£å†³**ï¼šç­‰å¾… 7 å¤©æˆ–æ‰‹åŠ¨åˆ é™¤ ip_ban.txt

### é—®é¢˜ 4ï¼šæ•°æ®åº“é”å®š
**åŸå› **ï¼šé•¿äº‹åŠ¡æˆ–å¹¶å‘å†²çª
**æ£€æŸ¥**ï¼šæ•°æ®åº“æ—¥å¿—æˆ–å¢åŠ  PRAGMA è¶…æ—¶
**è§£å†³**ï¼š
```bash
rm .tiec/tasks.db-wal .tiec/tasks.db-shm  # æ¸…ç† WAL
```

---

## å®‰å…¨è€ƒè™‘

### å·²å®ç°
âœ… ZIP Slip é˜²æŠ¤ï¼ˆè·¯å¾„éªŒè¯ï¼‰
âœ… æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ100MBï¼‰
âœ… MIME ç±»å‹éªŒè¯
âœ… IP é™æµä¸å°ç¦
âœ… SHA1 æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ
âœ… å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆåŸºäº user_id/IPï¼‰

### å»ºè®®å¢å¼º
âš ï¸ å®ç° API å¯†é’¥é‰´æƒï¼ˆå½“å‰æ— è®¤è¯ï¼‰
âš ï¸ HTTPS/TLS æ”¯æŒ
âš ï¸ è¯·æ±‚ç­¾åéªŒè¯
âš ï¸ å®¡è®¡æ—¥å¿—

---

## ç¼–è¯‘å·¥å…·é“¾é›†æˆ

### é¡¹ç›®ç¼–è¯‘å‘½ä»¤

```bash
./tiec \
  -o /build \
  --platform android \
  --android.gradle \
  --android.app.config project.json \
  --release \
  --log-level error \
  --dir æºæ–‡ä»¶ç›®å½•
```

### project.json é…ç½®æ ¼å¼

```json
{
  "appName": "åº”ç”¨åç§°",
  "appIcon": "å›¾æ ‡è·¯å¾„",
  "minSdk": 21,
  "targetSdk": 34,
  "versionCode": 1,
  "versionName": "1.0.0"
}
```

---

## æ‰©å±•å»ºè®®

### çŸ­æœŸ
- [ ] å®ç° WebSocket å®æ—¶æ—¥å¿—æ¨é€ï¼ˆæ›¿ä»£è½®è¯¢ï¼‰
- [ ] æ·»åŠ ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦å™¨
- [ ] æ”¯æŒä»»åŠ¡æš‚åœ/å–æ¶ˆ
- [ ] æ„å»ºäº§ç‰© CDN ç¼“å­˜

### ä¸­æœŸ
- [ ] å¤šæ•°æ®åº“æ”¯æŒï¼ˆPostgreSQLï¼‰
- [ ] åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—ï¼ˆRedis/RabbitMQï¼‰
- [ ] é›†ç¾¤éƒ¨ç½²æ”¯æŒ
- [ ] Web ç®¡ç†é¢æ¿

### é•¿æœŸ
- [ ] å¾®æœåŠ¡æ¶æ„ï¼ˆåˆ†ç¦»ç¼–è¯‘ã€ä¸Šä¼ ã€ä¸‹è½½ï¼‰
- [ ] Kubernetes åŸç”Ÿæ”¯æŒ
- [ ] CI/CD æµæ°´çº¿é›†æˆï¼ˆGitLab/GitHub Actionsï¼‰

---

## å‚è€ƒèµ„æº

- **Actix-web æ–‡æ¡£**ï¼šhttps://actix.rs/
- **Tokio æ–‡æ¡£**ï¼šhttps://tokio.rs/
- **Rusqlite æ–‡æ¡£**ï¼šhttps://docs.rs/rusqlite/
- **OpenAPI 3.0 è§„èŒƒ**ï¼šhttps://spec.openapis.org/oas/v3.0.3
- **GitHub Actions CI/CD**ï¼šhttps://docs.github.com/en/actions

---

## è®¸å¯è¯

å†…éƒ¨ä½¿ç”¨æˆ–æŒ‰é¡¹ç›®è¦æ±‚æŒ‡å®šã€‚

**æœ€åæ›´æ–°**ï¼š2026-02-01
